name: Tailscale Windows VPS (6h session + user)

on:
  workflow_dispatch:

jobs:
  connect:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: دانلود و نصب Tailscale
        run: |
          curl -L -o tailscale.msi https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi
          msiexec /i tailscale.msi /qn

      - name: ورود به Tailscale
        shell: powershell
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey $env:TS_AUTHKEY `
            --hostname github-vps `
            --accept-dns=true
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}

      - name: ایجاد یوزر جدید برای RDP
        shell: powershell
        run: |
          $username = "Admin"
          $password = $env:WIN_PASSWORD

          net user $username $password /add
          net localgroup administrators $username /add

          Write-Host "User $username created"
        env:
          WIN_PASSWORD: ${{ secrets.WIN_PASSWORD }}

      - name: نمایش IP و وضعیت Tailscale
        shell: powershell
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          & "C:\Program Files\Tailscale\tailscale.exe" status

      - name: نگه داشتن سشن برای 6 ساعت
        shell: powershell
        run: |
          Write-Host "Keeping session alive for 6 hours..."
          Start-Sleep -Seconds 21600
